# thread-image-menu Specification

## Purpose
TBD - created by archiving change add-batch-image-save. Update Purpose after archive.
## Requirements
### Requirement: レス内画像の一括保存
システムは画像メニューに「レス内の画像をすべて保存」を提供し、選択時に対象レス本文の画像URLをまとめて保存するSHALL。

#### Scenario: レス内画像をまとめて保存する
- **WHEN** ユーザーが画像サムネイルを長押しして「レス内の画像をすべて保存」を選択する
- **THEN** レス本文から抽出した画像URLを一括で保存する

#### Scenario: 同一URLは1回だけ保存する
- **WHEN** レス本文に同一の画像URLが複数回含まれる
- **THEN** 当該URLの保存処理は1回だけ実行される

#### Scenario: 画像が1件のみの場合はメニューを表示しない
- **WHEN** 対象レス本文に画像URLが1件だけ含まれる
- **THEN** 「レス内の画像をすべて保存」は表示されない

### Requirement: 一括保存結果の件数通知
システムはレス内画像の一括保存完了後に、成功件数と失敗件数を通知するSHALL。通知文言と判定条件は画像ビューアの保存結果通知と同一契約で処理しなければならないMUST。

#### Scenario: 成功件数と失敗件数を表示する
- **WHEN** 一括保存が完了する
- **THEN** 成功件数と失敗件数をユーザーへ通知する

#### Scenario: 画像ビューアと同一の結果判定で通知する
- **WHEN** 一括保存の結果として成功と失敗が混在する
- **THEN** システムは画像ビューアと同じ判定基準で部分成功の通知文言を表示する

### Requirement: 画像メニューアクション実行の共通化
システムはスレッド画面の画像メニューで選択されたアクション実行を、画像ビューアと共通の実行処理で行うMUST。保存アクションについては、URL正規化・権限判定・保留URL管理・保存実行・結果通知までを画像ビューアと同一フローで処理しなければならないMUST。

#### Scenario: 同一アクションで同一の副作用を実行する
- **WHEN** ユーザーがスレッド画面の画像メニューからコピー、共有、外部アプリ起動、Web検索、保存のいずれかを選択する
- **THEN** システムは画像ビューアと同じ実行契約に従って対象画像に対する処理を開始する

#### Scenario: 画像URLが空の場合は処理しない
- **WHEN** 対象画像URLが空または無効な状態で画像メニューアクションが発火する
- **THEN** システムは副作用処理を実行せず、クラッシュせずに処理を終了する

#### Scenario: 権限許可後に同一対象で保存を再開する
- **WHEN** 保存権限が必要な端末で、権限要求後にユーザーが許可する
- **THEN** システムは権限要求前に保持した同一URL集合で保存処理を再開する

## ADDED Requirements

### Requirement: 共有・外部アプリ起動前処理での表示済み画像データ再利用
システムはスレッド画面および画像ビューア画面から起動する画像共有系アクション（共有、外部アプリ起動）において、表示済み画像データから再利用可能な共有URIを優先して使用しなければならないMUST。再利用に失敗した場合のみ、既存のURL取得フローへフォールバックしなければならないMUST。

#### Scenario: 表示済み画像の共有で再利用URIを優先する
- **WHEN** ユーザーが一度表示済みの画像に対して共有または外部アプリ起動を実行する
- **THEN** システムは再利用可能な共有URIを優先的に使用してアクションを開始する

#### Scenario: 再利用不可時は既存取得フローへフォールバックする
- **WHEN** 再利用用メタデータが未登録または無効で共有URIを復元できない
- **THEN** システムは既存のURL取得フローへ切り替え、共有または外部アプリ起動を継続する
## ADDED Requirements

### Requirement: 共有再利用メタデータの型情報管理
システムは共有系アクションの再利用メタデータとして、画像URLに対して `diskCacheKey` に加え、画像拡張子とMIME情報を保持しなければならないMUST。型情報は共有URI生成で再利用され、画像として解釈できる値へ正規化されなければならないMUST。

#### Scenario: 表示成功時に拡張子とMIMEを登録する
- **WHEN** 画像表示が成功し、共有再利用メタデータを記録する
- **THEN** システムは `diskCacheKey` とともに拡張子およびMIMEを正規化して保存する

#### Scenario: 型情報が不正な場合は安全既定値を使う
- **WHEN** 再利用メタデータの拡張子またはMIMEが空、または画像型として無効である
- **THEN** システムは共有URI生成時に `jpg` と `image/jpeg` を適用する

### Requirement: 共有URI生成における型情報優先
システムは共有/外部アプリ起動の再利用経路で、キャッシュ実ファイル名に依存せず再利用メタデータの型情報を優先して共有ファイルを生成しなければならないMUST。

#### Scenario: キャッシュ実ファイル名が画像拡張子でなくてもプレビュー可能な共有を行う
- **WHEN** 再利用元キャッシュの実ファイル名が画像拡張子を持たない
- **THEN** システムは再利用メタデータの拡張子/MIMEを用いて共有ファイルを生成し、共有シートで画像として扱えるURIを提供する
