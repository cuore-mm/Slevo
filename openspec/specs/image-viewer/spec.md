# image-viewer Specification

## Purpose
TBD - created by archiving change add-image-viewer-swipe. Update Purpose after archive.
## Requirements
### Requirement: レス内画像のスワイプ閲覧
システムは画像ビューアで、同一レス本文から抽出した画像URLを左右スワイプで切り替えられるようにするSHALL。

#### Scenario: 同一レスの画像を横スワイプで切り替える
- **WHEN** ユーザーがレス内の画像サムネイルから画像ビューアを開き、同一レス内に複数画像が存在する
- **THEN** 画像ビューアはレス本文の画像URL順にページを並べ、左右スワイプで切り替えられる

### Requirement: 初期表示画像の一致
システムは画像ビューアを開いた際、タップされた画像URLを初期ページに設定するSHALL。

#### Scenario: タップした画像を初期表示する
- **WHEN** ユーザーがレス内の画像サムネイルをタップして画像ビューアを開く
- **THEN** 画像ビューアは該当URLの画像を最初に表示する

### Requirement: 切替対象の限定
システムは画像ビューアの切替対象を同一レス本文から抽出した画像URLに限定するSHALL。

#### Scenario: 他レスの画像を含めない
- **WHEN** ユーザーが画像ビューアを開く
- **THEN** 切り替え可能な画像は同じレス本文から抽出されたURLのみで構成される

### Requirement: サムネイルバーの表示
システムは画像ビューア下部に、同一レス本文から抽出した画像URLのサムネイルを横並びで表示するSHALL。

#### Scenario: 同一レス内画像のサムネイルを表示する
- **WHEN** ユーザーが画像ビューアを開く
- **THEN** 画像ビューア下部に同一レス本文の画像サムネイルが横並びで表示される

### Requirement: サムネイル表示の連動
システムは画像ビューアの上部バー表示と連動してサムネイルバーの表示/非表示を切り替えるSHALL。

#### Scenario: タップでバー表示を切り替える
- **WHEN** ユーザーが画像をタップして上部バー表示を切り替える
- **THEN** サムネイルバーの表示も同様に切り替わる

### Requirement: 表示中サムネイルの強調と中央寄せ
システムは表示中の画像サムネイルを少し拡大して強調し、サムネイル一覧の中央に表示するようスクロールするSHALL。

#### Scenario: 現在表示中のサムネイルが中央に位置する
- **WHEN** ユーザーが画像をスワイプ、またはサムネイルをタップして表示画像が切り替わる
- **THEN** 該当サムネイルが拡大表示され、サムネイル一覧の中央付近に表示される

### Requirement: サムネイルタップで切替
システムはサムネイルをタップしたとき、その画像に表示を切り替えるSHALL。

#### Scenario: サムネイルタップで表示画像を変更する
- **WHEN** ユーザーがサムネイルをタップする
- **THEN** 画像ビューアの表示がタップした画像に切り替わる

### Requirement: 画像ビューアトップバーの保存操作
システムは画像ビューアのトップバーに保存アクションを表示し、現在表示中の画像に対して保存操作を開始できるようにするSHALL。保存開始時は権限状態を確認し、必要な場合は権限要求を経由して同一の保存フローを継続しなければならないMUST。

#### Scenario: 保存ボタンから現在画像を保存する
- **WHEN** ユーザーが画像ビューアのトップバーにある保存ボタンをタップする
- **THEN** システムは現在表示中の画像を保存対象として保存処理を開始する

#### Scenario: 権限が必要な端末で保存権限を要求する
- **WHEN** 保存操作開始時に端末が保存権限を要求し、権限が未許可である
- **THEN** システムは保存対象URLを保持したまま権限要求を表示し、許可後に同じ対象で保存処理を再開する

### Requirement: 画像ビューアトップバーのその他メニュー
システムは画像ビューアのトップバーにその他アクションボタンを表示し、押下時に `DropdownMenu` で単体保存以外の既存画像アクションを選択できるようにするSHALL。

#### Scenario: その他ボタンで追加アクションを表示する
- **WHEN** ユーザーが画像ビューアのトップバーにあるその他ボタンをタップする
- **THEN** システムは `DropdownMenu` を表示し、単体保存を除く既存画像アクションを表示する

#### Scenario: バー非表示時はメニューを閉じる
- **WHEN** ユーザー操作により画像ビューアのバー表示がオフになる
- **THEN** システムは表示中の `DropdownMenu` を閉じる

### Requirement: その他メニューのアクション実行
システムは画像ビューアのその他メニューで選択されたアクションを、既存の画像アクションと同等の処理で実行するSHALL。

#### Scenario: コピー/共有/外部アプリ起動/検索を実行する
- **WHEN** ユーザーがその他メニューからコピー、共有、外部アプリ起動、検索のいずれかを選択する
- **THEN** システムは現在表示中画像を対象に既存画像アクションと同等の処理を実行する

#### Scenario: その他メニューから一括保存を実行する
- **WHEN** 画像ビューアに複数画像があり、ユーザーがその他メニューから一括保存を選択する
- **THEN** システムは表示中レスの画像一覧を保存対象として保存処理を開始する

### Requirement: サムネイルバーのスクロールによる表示切替
システムはサムネイルバーのスクロール中、表示領域の中心に最も近いサムネイルを選択状態として扱い、表示画像をリアルタイムで切り替えるSHALL。

#### Scenario: 中央サムネイルに合わせて表示画像が切り替わる
- **WHEN** ユーザーがサムネイルバーをスクロールする
- **THEN** 中央に最も近いサムネイルが選択状態として拡大表示され、画像ビューアの表示がその画像に切り替わる

### Requirement: 画像ビューアアクション実行の共通化
システムは画像ビューアの保存ボタンおよびその他メニューから起動する画像アクションを、スレッド画面と共通の実行処理で行うMUST。保存アクションについては、権限判定・保留URL管理・保存結果通知の判定ロジックをスレッド画面と同一契約で実行しなければならないMUST。

#### Scenario: 共通ランナーで画像アクションを実行する
- **WHEN** ユーザーが画像ビューアでコピー、共有、外部アプリ起動、Web検索、保存のいずれかを選択する
- **THEN** システムはスレッド画面と同じ実行契約に従って対象画像に対する処理を開始する

#### Scenario: メニュー種別が異なっても処理契約は同じ
- **WHEN** スレッド画面はBottomSheet、画像ビューアはDropdownMenuから同一アクションを選択する
- **THEN** システムは同じ入力条件に対して同じ成功系・失敗系の実行結果を提供する

#### Scenario: 保存結果通知をスレッド画面と同一文言で表示する
- **WHEN** 画像ビューアで単体保存または一括保存が完了する
- **THEN** システムはスレッド画面と同一の判定条件（単体成功/単体失敗/全成功/全失敗/部分成功）で結果通知を表示する

### Requirement: 画像ビューア終了時のシステムバー状態復元
システムは画像ビューアのライフサイクル終了時に、表示開始前のシステムバー可視状態を復元しなければならないMUST。システムバーのアイコン外観設定（ライト/ダーク）およびナビゲーションバーコントラスト設定も、表示開始前の状態へ復元しなければならないMUST。

#### Scenario: バー非表示のまま戻っても次画面へ状態を漏らさない
- **WHEN** ユーザーが画像ビューア内でシステムバーを非表示にした後、戻る操作でビューアを終了する
- **THEN** システムは画像ビューア開始前のシステムバー可視状態を復元し、遷移先画面に immersive 状態を持ち越さない

#### Scenario: 入場前が非表示なら非表示状態を維持する
- **WHEN** 画像ビューア開始前の画面が system bars 非表示状態であり、ユーザーが画像ビューアを終了する
- **THEN** システムは system bars 非表示状態を維持し、復元処理で強制表示しない

### Requirement: 画像ビューア戻り遷移時のバー優先レイヤ維持
システムは画像ビューアから遷移元画面へ戻る共有トランジション中、画像本体がトップバーおよびサムネイルバーより前面に表示されないよう、遷移元と遷移先の shared element 描画ポリシーを一致させなければならないMUST。

#### Scenario: バー表示中に戻っても画像がバーの背面を維持する
- **WHEN** ユーザーが画像ビューアでトップバーとサムネイルバーを表示した状態で戻る操作を行う
- **THEN** 共有トランジション中の画像本体はバーUIの背面に維持され、バーより前面へ一時的に描画されない

### Requirement: 共有トランジション有効化フラグの適用整合
システムは画像サムネイルの shared element 適用を、画面状態で決まる有効化フラグと一致して制御しなければならないMUST。

#### Scenario: 共有トランジション無効時は shared element を付与しない
- **WHEN** 呼び出し元が shared transition を無効化するフラグでサムネイル描画を要求する
- **THEN** システムは対象サムネイルに shared element を付与せず、通常描画のみを行う

### Requirement: 遷移元文脈と一致する shared transition キー
システムは画像ビューア遷移時、遷移元サムネイルが使用した shared transition の表示文脈を引き継ぎ、ビューア側で同一キーを再構築しなければならないMUST。

#### Scenario: ポップアップ起点でも shared transition が成立する
- **WHEN** ユーザーが 2 段目以降のポップアップにある画像サムネイルをタップして画像ビューアを開く
- **THEN** システムは遷移元と同一の文脈情報を使って shared transition キーを構成し、遷移アニメーションを成立させる

#### Scenario: 投稿ダイアログ起点でも shared transition が成立する
- **WHEN** ユーザーが投稿ダイアログ本文内の画像サムネイルをタップして画像ビューアを開く
- **THEN** システムは投稿ダイアログ用の文脈情報を引き継いだ shared transition キーを構成し、遷移アニメーションを成立させる

### Requirement: shared transition 文脈追加後の既存遷移互換
システムは shared transition 用の文脈情報を追加しても、既存の画像ビューア初期表示契約を維持しなければならないMUST。

#### Scenario: 通常リスト起点の初期表示が変わらない
- **WHEN** ユーザーがスレッド通常リストの画像サムネイルをタップして画像ビューアを開く
- **THEN** システムは従来どおりタップした画像を初期ページとして表示する

#### Scenario: 投稿ダイアログ起点の初期表示が変わらない
- **WHEN** ユーザーが投稿ダイアログ本文内の画像サムネイルをタップして画像ビューアを開く
- **THEN** システムは従来どおりタップした画像を初期ページとして表示する

### Requirement: shared transition キー生成ロジックの共通利用
システムは画像ビューア側の shared transition キー生成に、遷移元サムネイル側と同じ共通ロジックを利用しなければならないMUST。

#### Scenario: 遷移元と遷移先で同一フォーマットを使用する
- **WHEN** 任意の起点（通常リスト、ポップアップ、投稿ダイアログ）から画像ビューアへ遷移する
- **THEN** システムは遷移元サムネイルと画像ビューアで同一のキー生成ロジックを用いて shared transition キーを構築する
### Requirement: 画像ビューア操作要素のタップ時視覚フィードバック
システムは画像ビューアのトップバー3ボタン（戻る、保存、その他）およびサムネイル項目をタップしたとき、押下中に縮小する視覚フィードバックを表示しなければならないMUST。フィードバックは既存の操作結果（戻る遷移、保存開始、メニュー表示、画像切替）を妨げてはならないMUST。

#### Scenario: トップバー3ボタンをタップしたときに縮小表示される
- **WHEN** ユーザーが画像ビューアのトップバーにある戻る、保存、その他のいずれかのボタンをタップする
- **THEN** システムは押下中に対象ボタンを一時的に縮小表示し、タップ完了後に通常サイズへ復帰させる

#### Scenario: サムネイルをタップしたときに縮小表示される
- **WHEN** ユーザーが画像ビューア下部のサムネイル項目をタップする
- **THEN** システムは押下中に対象サムネイルを一時的に縮小表示し、既存の画像切替処理を継続する

### Requirement: 画像ビューアトップバーの長押しツールチップ
システムは画像ビューアのトップバー3ボタン（戻る、保存、その他）を長押ししたとき、各ボタンの役割を示すプレーンツールチップを表示しなければならないMUST。

#### Scenario: 戻るボタンを長押しするとツールチップを表示する
- **WHEN** ユーザーが画像ビューアのトップバーにある戻るボタンを長押しする
- **THEN** システムは戻る操作を説明するプレーンツールチップを表示する

#### Scenario: 保存ボタンを長押しするとツールチップを表示する
- **WHEN** ユーザーが画像ビューアのトップバーにある保存ボタンを長押しする
- **THEN** システムは保存操作を説明するプレーンツールチップを表示する

#### Scenario: その他ボタンを長押しするとツールチップを表示する
- **WHEN** ユーザーが画像ビューアのトップバーにあるその他ボタンを長押しする
- **THEN** システムは追加操作メニューを説明するプレーンツールチップを表示する
## ADDED Requirements

### Requirement: 画像ビューアの表示モード連動背景配色
システムは画像ビューア画面の背景色を表示モードに応じて切り替えなければならないMUST。ライトモードでは白、ダークモードでは黒を適用しなければならないMUST。

#### Scenario: ライトモードでは背景が白になる
- **WHEN** ユーザーがライトモードで画像ビューアを表示する
- **THEN** システムは画像ビューア画面の背景色に白を適用する

#### Scenario: ダークモードでは背景が黒になる
- **WHEN** ユーザーがダークモードで画像ビューアを表示する
- **THEN** システムは画像ビューア画面の背景色に黒を適用する

### Requirement: 画像ビューアのバーとツールチップのモード連動配色
システムは画像ビューアのトップバーおよびサムネイルバー背景色を表示モードに応じて切り替えなければならないMUST。ライトモードでは半透明の白、ダークモードでは半透明の黒を適用しなければならないMUST。トップバーのアイコンボタン長押しで表示するツールチップ背景色にも同じモード連動ルールを適用しなければならないMUST。

#### Scenario: ライトモードではバーとツールチップ背景が半透明白になる
- **WHEN** ユーザーがライトモードで画像ビューアを表示し、トップバーやサムネイルバー、ツールチップを表示する
- **THEN** システムは各背景色に半透明の白を適用する

#### Scenario: ダークモードではバーとツールチップ背景が半透明黒になる
- **WHEN** ユーザーがダークモードで画像ビューアを表示し、トップバーやサムネイルバー、ツールチップを表示する
- **THEN** システムは各背景色に半透明の黒を適用する

### Requirement: 画像ビューア前景要素のコントラスト整合
システムは画像ビューア内の文字とアイコンの色を、背景色およびバー/ツールチップ背景色とのコントラストが確保できる配色へ切り替えなければならないMUST。

#### Scenario: ライト背景で前景要素が視認できる色になる
- **WHEN** ユーザーがライトモードで画像ビューアを表示する
- **THEN** システムは文字とアイコンに明色背景上で視認可能な暗色系の前景色を適用する

#### Scenario: ダーク背景で前景要素が視認できる色になる
- **WHEN** ユーザーがダークモードで画像ビューアを表示する
- **THEN** システムは文字とアイコンに暗色背景上で視認可能な明色系の前景色を適用する
## ADDED Requirements

### Requirement: 画像ビューア表示結果の共有前処理への引き継ぎ
システムは画像ビューアで表示に成功した画像について、共有系アクションの前処理で再利用可能な情報を共通実行処理へ引き継がなければならないMUST。引き継ぎ情報は画面固有の状態に閉じず、スレッド画面と共通の実行経路から参照できなければならないMUST。

#### Scenario: ビューアで表示済みの画像を共有すると再利用情報が使われる
- **WHEN** ユーザーが画像ビューアで表示中または直前に表示した画像に対して共有を実行する
- **THEN** システムは画像ビューアの表示成功時に記録した再利用情報を共有前処理で参照する

#### Scenario: 画面をまたいでも同一画像の再利用契約を維持する
- **WHEN** ユーザーが画像ビューアで表示した画像を閉じた後、スレッド画面から同一画像の共有または外部アプリ起動を実行する
- **THEN** システムは共通実行処理を通して再利用可能情報を参照し、再利用優先の契約を維持する
## ADDED Requirements

### Requirement: ビューア起点での共有型情報契約の一致
システムは画像ビューアで表示成功した画像について、スレッド画面と同一の型情報付き再利用メタデータ契約（拡張子/MIMEを含む）で共有系アクションへ引き継がなければならないMUST。

#### Scenario: ビューア起点共有でも画像プレビューが表示できる型情報を引き継ぐ
- **WHEN** ユーザーが画像ビューアで表示した画像を共有する
- **THEN** システムは拡張子/MIMEを含む再利用メタデータを使って共有URIを生成し、共有シートで画像プレビュー可能なデータを渡す

#### Scenario: 画面をまたいでも同一型情報契約を維持する
- **WHEN** ビューア表示後にスレッド画面へ戻って同一画像を共有または外部アプリ起動する
- **THEN** システムは共通ランナー経由で同一の型情報契約を適用する
## ADDED Requirements

### Requirement: 画像ビューアその他メニューのアンカー重ね表示
システムは画像ビューアのその他メニューを、その他ボタン（アンカー）の上に重なる位置で表示しなければならないMUST。配置計算は画面サイズを考慮し、表示領域外にはみ出す場合は画面内へ補正しなければならないMUST。

#### Scenario: その他ボタン上にメニューが重なって表示される
- **WHEN** ユーザーが画像ビューアのその他ボタンをタップする
- **THEN** システムはメニューをアンカーボタン上に重ねて表示する

#### Scenario: 画面端でもメニューが視認可能範囲に収まる
- **WHEN** アンカーが画面上端または左右端に近く、上方向重ね表示ではみ出しが発生する
- **THEN** システムはメニュー座標を補正し、画面内に収めて表示する

### Requirement: メニュー操作契約の維持
システムは表示位置変更後も、画像ビューアその他メニューの項目構成とアクション実行契約を維持しなければならないMUST。

#### Scenario: メニュー項目選択で既存アクションが実行される
- **WHEN** ユーザーがその他メニューの任意項目を選択する
- **THEN** システムは従来どおり対応する画像アクションを実行する

#### Scenario: メニュー外タップでdismissされる
- **WHEN** ユーザーがメニュー外領域をタップする
- **THEN** システムはメニューを閉じる
## ADDED Requirements

### Requirement: サムネイル表示成功時のみビューア遷移許可
システムは画像サムネイル起点で画像ビューアへ遷移する際、サムネイル表示が成功した項目のみ遷移を許可しなければならないMUST。読み込み中または表示失敗の項目はタップしても画像ビューアへ遷移してはならないMUST。

#### Scenario: 表示成功サムネイルをタップしたとき遷移する
- **WHEN** ユーザーが表示成功したサムネイルをタップする
- **THEN** システムは従来どおり画像ビューアへ遷移する

#### Scenario: 表示失敗サムネイルをタップしても遷移しない
- **WHEN** ユーザーが表示失敗したサムネイルをタップする
- **THEN** システムは画像ビューアへ遷移しない

#### Scenario: 読み込み中サムネイルをタップしても遷移しない
- **WHEN** ユーザーが読み込み中のサムネイルをタップする
- **THEN** システムは画像ビューアへ遷移しない

### Requirement: ビューア遷移時の画像一覧契約維持
システムはサムネイル遷移判定を追加しても、画像ビューアへ渡す画像URL一覧の契約を変更してはならないMUST。遷移入力の一覧は従来どおり同一投稿から抽出した画像URL集合を維持し、表示成功項目への絞り込みを行ってはならないMUST。

#### Scenario: 遷移時のURL一覧は従来契約を維持する
- **WHEN** ユーザーが表示成功サムネイルから画像ビューアへ遷移する
- **THEN** システムは従来と同じURL一覧と初期index計算で画像ビューアを起動する

### Requirement: 画像ビューアその他メニュー背景のhaze表示
システムは画像ビューアのその他メニュー背景にhaze（背景ぼかし）表現を適用しなければならないMUST。haze適用時は背後画像を透過的に認識できる状態を維持しつつ、メニュー項目の可読性を損なってはならないMUST。

#### Scenario: その他メニュー表示時に背景がぼかされる
- **WHEN** ユーザーが画像ビューアのその他ボタンを押してメニューを開く
- **THEN** システムはメニュー本体背景にhazeを適用し、背後画像がぼかし付きで視認できる表示にする

#### Scenario: haze適用時もメニュー文字が読める
- **WHEN** 背景が明るい画像または暗い画像の上でメニューを表示する
- **THEN** システムは各メニュー項目の文字を可読なコントラストで表示する

### Requirement: haze未適用時のフォールバック表示
システムはhazeが利用できない描画環境または適用失敗時に、既存の半透明Surface背景へフォールバックしなければならないMUST。フォールバック時もメニュー項目構成と操作契約を維持しなければならないMUST。

#### Scenario: haze利用不可でもメニュー表示が成立する
- **WHEN** 端末または描画条件によりhazeを適用できない
- **THEN** システムは半透明Surface背景でメニューを表示し、項目操作を継続可能にする

#### Scenario: フォールバック時も既存アクション契約を維持する
- **WHEN** フォールバック表示中にユーザーが任意のメニュー項目を選択する
- **THEN** システムは従来どおり対応する画像アクションを実行する
