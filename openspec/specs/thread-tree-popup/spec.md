# thread-tree-popup Specification

## Purpose
TBD - created by archiving change add-thread-tree-popup. Update Purpose after archive.
## Requirements
### Requirement: ツリー全体ポップアップ表示
システムはスレッド画面でレス本文/ヘッダーの通常タップ時に、該当レスの最上位祖先を起点とする同一ツリーの全投稿をポップアップ表示する SHALL。

#### Scenario: 親子関係があるレスをタップした場合
- **WHEN** ユーザーが親または子を持つレスの本文/ヘッダーを通常タップする
- **THEN** 最上位祖先から全子孫を含むツリー全体の投稿がポップアップ表示される

#### Scenario: 親子関係がないレスをタップした場合
- **WHEN** ユーザーが親も子も持たないレスの本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップは表示されない

### Requirement: ポップアップ内ツリー再表示抑止
システムはツリー全体ポップアップ内の本文/ヘッダー通常タップでは、ツリー全体ポップアップを新規表示しない SHALL。

#### Scenario: ポップアップ内のレス本文/ヘッダーをタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内のレス本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップが追加表示されない

### Requirement: 既存タップ挙動の維持
システムはツリー全体ポップアップ内でも、返信番号/返信元/ID/URL など既存のタップ挙動を維持する SHALL。

#### Scenario: ポップアップ内で返信番号をタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内で返信番号をタップする
- **THEN** 返信番号に対応したポップアップ表示が行われる

### Requirement: 多段ポップアップでの画像サムネイル表示維持
システムはレスポップアップが 2 段以上重なった状態でも、各ポップアップ内の画像サムネイルを欠落なく描画しなければならないMUST。

#### Scenario: 2 段目ポップアップでも画像が表示される
- **WHEN** ユーザーがレスを連続で辿って 2 段目以降のポップアップを開き、対象レスに画像 URL が含まれる
- **THEN** システムはサムネイル枠だけでなく画像本体を描画する

### Requirement: ポップアップ階層ごとの shared transition 識別
システムはポップアップ内画像サムネイルの shared transition 識別子に、ポップアップ階層を含む表示文脈を反映しなければならないMUST。

#### Scenario: 同一画像 URL が別階層に存在しても衝突しない
- **WHEN** 同じ画像 URL を含むレスが異なるポップアップ階層で同時に表示される
- **THEN** システムは階層ごとに衝突しない識別子で shared transition を構成し、どの階層でも画像サムネイル表示を維持する

### Requirement: ポップアップ識別子の安定性
システムはポップアップの shared transition 識別に、表示インデックスではなく生成時に固定される `popupId` を使用しなければならないMUST。

#### Scenario: 中間ポップアップが閉じても識別が変化しない
- **WHEN** ポップアップスタックの中間または下位ポップアップが閉じられて、残存ポップアップの表示インデックスが変化する
- **THEN** システムは残存ポップアップの `popupId` を維持し、shared transition 識別子を変化させない

