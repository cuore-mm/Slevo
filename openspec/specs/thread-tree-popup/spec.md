# thread-tree-popup Specification

## Purpose
TBD - created by archiving change add-thread-tree-popup. Update Purpose after archive.
## Requirements
### Requirement: ツリー全体ポップアップ表示
システムはスレッド画面でレス本文/ヘッダーの通常タップ時に、該当レスの最上位祖先を起点とする同一ツリーの全投稿をポップアップ表示する SHALL。

#### Scenario: 親子関係があるレスをタップした場合
- **WHEN** ユーザーが親または子を持つレスの本文/ヘッダーを通常タップする
- **THEN** 最上位祖先から全子孫を含むツリー全体の投稿がポップアップ表示される

#### Scenario: 親子関係がないレスをタップした場合
- **WHEN** ユーザーが親も子も持たないレスの本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップは表示されない

### Requirement: ポップアップ内ツリー再表示抑止
システムはツリー全体ポップアップ内の本文/ヘッダー通常タップでは、ツリー全体ポップアップを新規表示しない SHALL。

#### Scenario: ポップアップ内のレス本文/ヘッダーをタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内のレス本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップが追加表示されない

### Requirement: 既存タップ挙動の維持
システムはツリー全体ポップアップ内でも、返信番号/返信元/ID/URL など既存のタップ挙動を維持する SHALL。

#### Scenario: ポップアップ内で返信番号をタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内で返信番号をタップする
- **THEN** 返信番号に対応したポップアップ表示が行われる

### Requirement: 多段ポップアップでの画像サムネイル表示維持
システムはレスポップアップが 2 段以上重なった状態でも、各ポップアップ内の画像サムネイルを欠落なく描画しなければならないMUST。

#### Scenario: 2 段目ポップアップでも画像が表示される
- **WHEN** ユーザーがレスを連続で辿って 2 段目以降のポップアップを開き、対象レスに画像 URL が含まれる
- **THEN** システムはサムネイル枠だけでなく画像本体を描画する

### Requirement: ポップアップ階層ごとの shared transition 識別
システムはポップアップ内画像サムネイルの shared transition 識別子に、ポップアップ階層を含む表示文脈を反映しなければならないMUST。

#### Scenario: 同一画像 URL が別階層に存在しても衝突しない
- **WHEN** 同じ画像 URL を含むレスが異なるポップアップ階層で同時に表示される
- **THEN** システムは階層ごとに衝突しない識別子で shared transition を構成し、どの階層でも画像サムネイル表示を維持する

### Requirement: ポップアップ識別子の安定性
システムはポップアップの shared transition 識別に、表示インデックスではなく生成時に固定される `popupId` を使用しなければならないMUST。

#### Scenario: 中間ポップアップが閉じても識別が変化しない
- **WHEN** ポップアップスタックの中間または下位ポップアップが閉じられて、残存ポップアップの表示インデックスが変化する
- **THEN** システムは残存ポップアップの `popupId` を維持し、shared transition 識別子を変化させない

### Requirement: 画面復帰時の既存ポップアップ再表示アニメーション抑止
システムはスレッド画面でレスポップアップ表示中に他画面へ遷移し、同じスレッド画面へ復帰した場合、既に表示されていたポップアップへ enter アニメーションを再適用してはならないMUST。

#### Scenario: 画像ビューアから戻ったときは再アニメーションしない
- **WHEN** ユーザーがレスポップアップを表示した状態で画像ビューアへ遷移し、戻る操作でスレッド画面へ復帰する
- **THEN** システムは復帰前から表示中だったポップアップをそのまま表示し、enter アニメーションを発生させない

### Requirement: 新規追加ポップアップの表示アニメーション維持
システムは既存ポップアップ表示中に新しく追加されたポップアップに対しては、表示アニメーションを従来どおり適用しなければならないMUST。

#### Scenario: 復帰後に新規ポップアップを開くとアニメーションする
- **WHEN** ユーザーが画面復帰後に返信番号や ID 操作で新しいポップアップを追加表示する
- **THEN** システムは新規に追加されたポップアップへ enter アニメーションを適用する
### Requirement: ポップアップ連続同一表示の抑止
システムはレスポップアップ追加時に、現在表示中の最上位ポップアップと新規追加対象が同一内容である場合、新しいポップアップを追加してはならないMUST。

#### Scenario: 同一IDポップアップの連続追加を抑止する
- **WHEN** ユーザーがレスポップアップ内で同じ ID を連続してタップし、同一内容の ID ポップアップを続けて開こうとする
- **THEN** システムは新しいポップアップを追加せず、ポップアップ段数を増やさない

#### Scenario: 異なるポップアップを挟んだ同一再表示は許可する
- **WHEN** ユーザーが A ポップアップ表示後に別内容の B ポップアップを開き、その後に再び A と同一内容のポップアップを開く
- **THEN** システムは最後に表示中の B とは同一でないため、A ポップアップを新規追加する

#### Scenario: 返信番号経路でも連続同一表示を抑止する
- **WHEN** ユーザーが返信番号タップで同一内容の単体レスポップアップを連続して開こうとする
- **THEN** システムは連続する同一内容として判定し、新しいポップアップを追加しない


### Requirement: レスポップアップ内スクロール位置インジケーター表示
システムはスレッド画面のレスポップアップ内投稿一覧に、現在のスクロール位置を示すスクロールバーを表示しなければならないMUST。スクロールバーのつまみはドラッグ操作を受け付け、ドラッグ位置に応じてスクロール位置を変更しなければならないMUST。表示内容がポップアップ表示領域内に収まりスクロール不能な場合、システムはスクロールバーを表示してはならないMUST。既存のポップアップ内タップ挙動（返信番号/返信元/ID/URL/画像操作）および多段ポップアップ挙動は維持しなければならないMUST。

#### Scenario: 長いポップアップでスクロールバーが表示される
- **WHEN** ユーザーが複数レスを含むポップアップを開き、内容を縦スクロールする
- **THEN** ポップアップ内にスクロール位置を示すスクロールバーが表示され、スクロール進行に応じて表示位置が更新される

#### Scenario: スクロールバーつまみをドラッグすると位置が変わる
- **WHEN** ユーザーがポップアップ内スクロールバーのつまみをドラッグする
- **THEN** つまみ位置に応じて投稿一覧のスクロール位置が更新される

#### Scenario: スクロール不能なポップアップではスクロールバーを表示しない
- **WHEN** ユーザーが投稿数の少ないレスポップアップを開き、一覧が表示領域に収まって縦スクロールできない
- **THEN** システムはポップアップ内スクロールバーを表示しない

#### Scenario: スクロールバー追加後も既存操作は維持される
- **WHEN** ユーザーがスクロールバー表示中のポップアップ内で返信番号や ID をタップする
- **THEN** 既存どおり対応するポップアップ遷移が実行され、追加のスクロールバー表示はその挙動を阻害しない

### Requirement: レスポップアップ段数ごとの最大高さ縮小
システムはスレッド画面でレスポップアップを2段以上表示する場合、段数が深くなるほどポップアップの最大高さを段階的に小さくしなければならないMUST。1段目の最大高さを基準とし、2段目以降は単調減少する規則で計算しなければならないMUST。

#### Scenario: 2段目以降のポップアップ最大高さが段階的に縮小される
- **WHEN** ユーザーがレスポップアップを連続で開いて2段目以降を表示する
- **THEN** システムは段数に応じて各ポップアップの最大高さを順に小さく適用する

### Requirement: レスポップアップ最大高さの下限制約
システムはレスポップアップの段階縮小時に、可読性を維持するための最小最大高さを下回ってはならないMUST。段数が増えても、最大高さは定義した下限値でクランプしなければならないMUST。

#### Scenario: 深い段数でも最大高さが下限を下回らない
- **WHEN** ユーザーが深い段数までレスポップアップを重ねて表示する
- **THEN** システムは最大高さを下限値で維持し、それ未満へ縮小しない

### Requirement: 多段ポップアップのタップ投稿基準表示
システムは、レスポップアップ内で返信番号・返信元・ID・本文/ヘッダーの操作によって新しいポップアップを追加する場合、段数に関係なくユーザーがタップした投稿の画面座標を表示基準として使用しなければならないMUST。直前ポップアップ全体の座標を次段の基準として再利用してはならないMUST NOT。

#### Scenario: 2段目以降でもタップした投稿を基準に開く
- **WHEN** ユーザーが既存ポップアップ内の投稿をタップして次のポップアップを開く
- **THEN** システムはタップした投稿の座標を基準に新規ポップアップを表示する

### Requirement: 多段ポップアップでの重なり表示契約
システムは、2段目以降のポップアップ表示位置を1段目と同様の重なり契約で計算し、タップした投稿と新規ポップアップがわずかに重なる配置を維持しなければならないMUST。段数が増えても、この重なり契約を一貫して適用しなければならないMUST。

#### Scenario: 多段でも1段目同様に少し重なる
- **WHEN** ユーザーがポップアップ内投稿を起点に新規ポップアップを連続で追加する
- **THEN** 各新規ポップアップは対応するタップ投稿と少し重なる位置に表示される

### Requirement: ポップアップ配置計算の単一経路化
システムは、レスポップアップの表示位置計算を単一の計算経路で実行しなければならないMUST。段数別左余白、右余白固定、右端見切れ防止、Y座標補正は同一の配置計算契約内で一貫して処理されなければならないMUST。

#### Scenario: 同一入力で一貫した配置結果を返す
- **WHEN** システムが同じ段数・同じ基準座標・同じ画面幅/ポップアップ幅を入力として配置計算する
- **THEN** システムは常に同じ X/Y 結果を返す
- **AND** 計算責務は単一の配置計算契約で完結する

### Requirement: 未計測時フォールバックの明示化
システムは、ポップアップサイズまたは座標が未計測な状態を通常配置計算と区別して扱わなければならないMUST。未計測時の処理は疑似的な極大値入力に依存せず、明示的なフォールバック手順として実装されなければならないMUST。

#### Scenario: 未計測状態でも定義済みフォールバックで表示する
- **WHEN** ポップアップサイズが未計測の状態で表示位置計算が必要になる
- **THEN** システムは明示的な未計測フォールバック手順を適用する
- **AND** 疑似的な極大値を通常計算へ投入して挙動を代替しない

### Requirement: ポップアップ外タップ判定の全画面適用
システムはレスポップアップ表示中、ポップアップ外タップ判定をスレッド content 領域に限定せず、画面全体に適用しなければならないMUST。bottomBar 領域のタップもポップアップ外タップとして扱わなければならないMUST。

#### Scenario: bottomBar タップで最上位ポップアップが閉じる
- **WHEN** ユーザーがポップアップ表示中に bottomBar 領域をタップする
- **THEN** システムはそのタップをポップアップ外タップとして扱い、最上位ポップアップを閉じる

### Requirement: ポップアップ上位レイヤー描画
システムはレスポップアップを、Scaffold の content と bottomBar の双方を覆える上位レイヤーで描画しなければならないMUST。これにより、画面全体で一貫した外側タップ挙動を提供しなければならないMUST。

#### Scenario: content と bottomBar の双方で外側タップが同一挙動になる
- **WHEN** ユーザーがポップアップ外の content 領域または bottomBar 領域をタップする
- **THEN** システムはどちらの場合も同じ閉じる挙動を実行する

### Requirement: ポップアップ右端見切れ防止
システムは、レスポップアップ表示時にポップアップ右端が画面外へ出ないようにしなければならないMUST。表示位置計算では、画面右端に 4.dp の余白を常に確保しなければならないMUST。

#### Scenario: 右端付近でも右側が見切れない
- **WHEN** ユーザーが画面右端付近の投稿を起点にレスポップアップを開く
- **THEN** システムはポップアップの右側が見切れない位置へ補正して表示する
- **AND** 右側余白は 4.dp を維持する

### Requirement: 右端補正時の左側余白拡張許容
システムは、右端見切れ回避のために必要な場合、ポップアップの X 座標を左方向へ補正し、左側余白が増える配置を許容しなければならないMUST。段数に伴う右方向ずらしの方針は維持しつつ、画面外表示を優先して防止しなければならないMUST。

#### Scenario: 多段で右端補正が必要な場合は左へ押し戻される
- **WHEN** ユーザーが多段でポップアップを重ね、通常配置だと右端を超える
- **THEN** システムは右余白 4.dp を保つよう左方向へ補正して表示する

### Requirement: 左余白の最大値制約
システムは、右端補正によって左余白が増加する場合でも、左余白が定義済みの最大値を超えないよう制約しなければならないMUST。左余白が上限に達した場合は、それ以上左側へ寄せずに表示しなければならないMUST。

#### Scenario: 左余白上限を超える補正は行わない
- **WHEN** 多段表示の補正結果が左余白の上限値を超える
- **THEN** システムは左余白を上限値で固定して表示する

