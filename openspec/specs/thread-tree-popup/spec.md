# thread-tree-popup Specification

## Purpose
TBD - created by archiving change add-thread-tree-popup. Update Purpose after archive.
## Requirements
### Requirement: ツリー全体ポップアップ表示
システムはスレッド画面でレス本文/ヘッダーの通常タップ時に、該当レスの最上位祖先を起点とする同一ツリーの全投稿をポップアップ表示する SHALL。

#### Scenario: 親子関係があるレスをタップした場合
- **WHEN** ユーザーが親または子を持つレスの本文/ヘッダーを通常タップする
- **THEN** 最上位祖先から全子孫を含むツリー全体の投稿がポップアップ表示される

#### Scenario: 親子関係がないレスをタップした場合
- **WHEN** ユーザーが親も子も持たないレスの本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップは表示されない

### Requirement: ポップアップ内ツリー再表示抑止
システムはツリー全体ポップアップ内の本文/ヘッダー通常タップでは、ツリー全体ポップアップを新規表示しない SHALL。

#### Scenario: ポップアップ内のレス本文/ヘッダーをタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内のレス本文/ヘッダーを通常タップする
- **THEN** ツリー全体ポップアップが追加表示されない

### Requirement: 既存タップ挙動の維持
システムはツリー全体ポップアップ内でも、返信番号/返信元/ID/URL など既存のタップ挙動を維持する SHALL。

#### Scenario: ポップアップ内で返信番号をタップした場合
- **WHEN** ユーザーがツリー全体ポップアップ内で返信番号をタップする
- **THEN** 返信番号に対応したポップアップ表示が行われる

### Requirement: 多段ポップアップでの画像サムネイル表示維持
システムはレスポップアップが 2 段以上重なった状態でも、各ポップアップ内の画像サムネイルを欠落なく描画しなければならないMUST。

#### Scenario: 2 段目ポップアップでも画像が表示される
- **WHEN** ユーザーがレスを連続で辿って 2 段目以降のポップアップを開き、対象レスに画像 URL が含まれる
- **THEN** システムはサムネイル枠だけでなく画像本体を描画する

### Requirement: ポップアップ階層ごとの shared transition 識別
システムはポップアップ内画像サムネイルの shared transition 識別子に、ポップアップ階層を含む表示文脈を反映しなければならないMUST。

#### Scenario: 同一画像 URL が別階層に存在しても衝突しない
- **WHEN** 同じ画像 URL を含むレスが異なるポップアップ階層で同時に表示される
- **THEN** システムは階層ごとに衝突しない識別子で shared transition を構成し、どの階層でも画像サムネイル表示を維持する

### Requirement: ポップアップ識別子の安定性
システムはポップアップの shared transition 識別に、表示インデックスではなく生成時に固定される `popupId` を使用しなければならないMUST。

#### Scenario: 中間ポップアップが閉じても識別が変化しない
- **WHEN** ポップアップスタックの中間または下位ポップアップが閉じられて、残存ポップアップの表示インデックスが変化する
- **THEN** システムは残存ポップアップの `popupId` を維持し、shared transition 識別子を変化させない

### Requirement: 画面復帰時の既存ポップアップ再表示アニメーション抑止
システムはスレッド画面でレスポップアップ表示中に他画面へ遷移し、同じスレッド画面へ復帰した場合、既に表示されていたポップアップへ enter アニメーションを再適用してはならないMUST。

#### Scenario: 画像ビューアから戻ったときは再アニメーションしない
- **WHEN** ユーザーがレスポップアップを表示した状態で画像ビューアへ遷移し、戻る操作でスレッド画面へ復帰する
- **THEN** システムは復帰前から表示中だったポップアップをそのまま表示し、enter アニメーションを発生させない

### Requirement: 新規追加ポップアップの表示アニメーション維持
システムは既存ポップアップ表示中に新しく追加されたポップアップに対しては、表示アニメーションを従来どおり適用しなければならないMUST。

#### Scenario: 復帰後に新規ポップアップを開くとアニメーションする
- **WHEN** ユーザーが画面復帰後に返信番号や ID 操作で新しいポップアップを追加表示する
- **THEN** システムは新規に追加されたポップアップへ enter アニメーションを適用する
### Requirement: ポップアップ連続同一表示の抑止
システムはレスポップアップ追加時に、現在表示中の最上位ポップアップと新規追加対象が同一内容である場合、新しいポップアップを追加してはならないMUST。

#### Scenario: 同一IDポップアップの連続追加を抑止する
- **WHEN** ユーザーがレスポップアップ内で同じ ID を連続してタップし、同一内容の ID ポップアップを続けて開こうとする
- **THEN** システムは新しいポップアップを追加せず、ポップアップ段数を増やさない

#### Scenario: 異なるポップアップを挟んだ同一再表示は許可する
- **WHEN** ユーザーが A ポップアップ表示後に別内容の B ポップアップを開き、その後に再び A と同一内容のポップアップを開く
- **THEN** システムは最後に表示中の B とは同一でないため、A ポップアップを新規追加する

#### Scenario: 返信番号経路でも連続同一表示を抑止する
- **WHEN** ユーザーが返信番号タップで同一内容の単体レスポップアップを連続して開こうとする
- **THEN** システムは連続する同一内容として判定し、新しいポップアップを追加しない

