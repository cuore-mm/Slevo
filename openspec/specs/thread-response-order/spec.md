# thread-response-order Specification

## Purpose
TBD - created by archiving change update-thread-response-order. Update Purpose after archive.
## Requirements
### Requirement: 既存レス順を維持した新着グループ追加
システムは、スレッドのリロードで取得した新着レスを「更新単位のグループ」として末尾に追加し、既存レスの表示順を維持しなければならない（SHALL）。
この挙動は NUMBER/TREE の両方で適用し、グループ内の整形は現行ロジックを踏襲しなければならない（SHALL）。

#### Scenario: NUMBER で既存順を保ったまま新着を末尾へ追加する
- **WHEN** NUMBER 表示でスレッドをリロードし新着レスが取得される
- **THEN** 既存レスの順序は保持され、新着レスは末尾の新グループとして追加される

#### Scenario: TREE で既存順を保ったまま新着を末尾へ追加する
- **WHEN** TREE 表示でスレッドをリロードし新着レスが取得される
- **THEN** 既存レスの順序は保持され、新着レスは末尾の新グループとして追加される

### Requirement: 新着バーの表示位置を最新グループ先頭に固定
システムは、新着バーを最新の新着グループ先頭にのみ表示しなければならない（SHALL）。
新着レスが0件の更新では新着バーを表示してはならない（MUST NOT）。

#### Scenario: 最新グループ先頭に新着バーを表示する
- **WHEN** 新着レスが取得され、最新グループが末尾に追加される
- **THEN** 新着バーはそのグループの先頭にのみ表示される

#### Scenario: 新着0件の更新では新着バーを表示しない
- **WHEN** リロードで新着レスが取得されない
- **THEN** 新着バーは表示されない

### Requirement: グループ状態の保持範囲
システムは、新着グループの状態をスレッドタブが閉じられるまで ViewModel 内で保持しなければならない（SHALL）。

#### Scenario: タブを閉じるまでグループが維持される
- **WHEN** 同一スレッドを複数回リロードして新着グループが追加される
- **THEN** 既存グループは保持され、最新グループのみが末尾に追加され続ける

### Requirement: スレッド一覧の表示キー一意性
システムは、THREAD画面のレス一覧を描画する際、同一更新セッション内で同じレス番号が複数回表示される場合でも、`LazyColumn` の各表示行に一意なキーを割り当てなければならない（SHALL）。
この要件は TREE 表示および NUMBER 表示の両方に適用されなければならない（SHALL）。

#### Scenario: TREE表示で複数更新グループがある場合もキーが重複しない
- **WHEN** TREE表示でスレッドを複数回更新し、既存レスと新着グループの組み合わせにより同一レス番号が一覧内へ再登場する
- **THEN** 一覧内の各表示行キーは重複せず、描画処理は継続される

#### Scenario: キー重複が発生しないためクラッシュしない
- **WHEN** ユーザーがTHREAD画面を開いたまま更新を繰り返す
- **THEN** `Key "..." was already used` に起因する `IllegalArgumentException` は発生しない

