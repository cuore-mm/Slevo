## ADDED Requirements

### Requirement: 多段ポップアップでの画像サムネイル表示維持
システムはレスポップアップが 2 段以上重なった状態でも、各ポップアップ内の画像サムネイルを欠落なく描画しなければならないMUST。

#### Scenario: 2 段目ポップアップでも画像が表示される
- **WHEN** ユーザーがレスを連続で辿って 2 段目以降のポップアップを開き、対象レスに画像 URL が含まれる
- **THEN** システムはサムネイル枠だけでなく画像本体を描画する

### Requirement: ポップアップ階層ごとの shared transition 識別
システムはポップアップ内画像サムネイルの shared transition 識別子に、ポップアップ階層を含む表示文脈を反映しなければならないMUST。

#### Scenario: 同一画像 URL が別階層に存在しても衝突しない
- **WHEN** 同じ画像 URL を含むレスが異なるポップアップ階層で同時に表示される
- **THEN** システムは階層ごとに衝突しない識別子で shared transition を構成し、どの階層でも画像サムネイル表示を維持する

### Requirement: ポップアップ識別子の安定性
システムはポップアップの shared transition 識別に、表示インデックスではなく生成時に固定される `popupId` を使用しなければならないMUST。

#### Scenario: 中間ポップアップが閉じても識別が変化しない
- **WHEN** ポップアップスタックの中間または下位ポップアップが閉じられて、残存ポップアップの表示インデックスが変化する
- **THEN** システムは残存ポップアップの `popupId` を維持し、shared transition 識別子を変化させない
