## Context

現行の投稿送信処理は、`URLEncoder.encode(..., "Shift_JIS")` で値を事前エンコードしたうえで `FormBody.Builder(...).addEncoded(...)` に渡している。これにより Shift_JIS 非対応文字（絵文字、結合文字を含む拡張書記素クラスタ）が投稿本文・名前・メール等に含まれると、送信時に文字化けまたは意図しない代替文字へ変換される。

影響範囲は返信投稿とスレ立て投稿の一次送信・確認送信の計 4 経路で、いずれも同種のエンコード処理を持つ。5ch 側 API のフォームキー契約は維持しつつ、値エンコードの扱いだけを統一して修正する必要がある。

## Goals / Non-Goals

**Goals:**
- Shift_JIS 非対応文字を含む入力でも、投稿先で可読な形（NCR）で保持されること。
- 返信投稿・スレ立て投稿の一次送信/確認送信で同一の変換ルールを適用すること。
- Shift_JIS で表現可能な文字列は既存挙動と互換に保つこと。

**Non-Goals:**
- 投稿 API のエンドポイント、パラメータキー、送信フロー自体の変更。
- HTML エンティティ全般への変換拡張（named entity 等）。
- 受信表示側（dat 取得・描画）の文字処理仕様の変更。

## Decisions

### 1) Shift_JIS 非対応文字は送信前に NCR へ置換する
- 決定: 入力文字列を Unicode 拡張書記素クラスタ単位で走査し、Shift_JIS でエンコード不能なクラスタのみコードポイントごとの数値文字参照（`&#<codePoint>;`）に置換する。
- 理由: 絵文字の一部は複数コードポイントで 1 文字として扱う必要があり、`Char` 単位走査では変換漏れや分断が起きるため。
- 代替案:
  - UTF-8 送信へ全面変更: 5ch 側契約と互換性リスクが高く不採用。
  - 文字ごとの単純置換（BMP 前提）: サロゲートペアや結合シーケンスの扱いが不十分で不採用。

### 2) フォーム値は addEncoded ではなく add で構築する
- 決定: フォーム生成時は `FormBody.Builder(Charset.forName("Shift_JIS"))` と `add(...)` を使用し、URL エンコードを OkHttp に委譲する。
- 理由: 事前に `URLEncoder` で加工した値を `addEncoded` へ渡す二重責務を解消し、エンコード経路を単一化できるため。
- 代替案:
  - 既存の `URLEncoder + addEncoded` を維持し一部文字のみ手当て: 経路ごとの差異が残り再発リスクが高いため不採用。

### 3) 変換ロジックを共通ヘルパー化し 4 経路へ適用する
- 決定: 投稿関連 4 経路で同じ変換関数を利用し、`MESSAGE` に加えて `name`/`mail`/`subject` にも同一変換を必須適用する。
- 理由: 一次送信と確認送信で実装差があると再び文字化けが混在するため。
- 代替案:
  - 経路ごと個別実装: 保守コスト・仕様乖離リスクが高く不採用。

## Risks / Trade-offs

- [Risk] 投稿先が NCR を想定通りデコードしない板がある → Mitigation: 5ch 主要板で返信/スレ立て双方の実送信確認を行う。
- [Risk] 変換により文字列長が増え、サーバー上限へ近づく → Mitigation: 既存の文字数制限判定と併せて、絵文字多用ケースの手動確認を追加する。
- [Trade-off] 可逆性より投稿成功率を優先し、非対応文字は原文保持ではなく NCR 表現になる。

## Migration Plan

1. 投稿・スレ立ての送信コードに共通変換関数を適用する。
2. `URLEncoder + addEncoded` 経路を `add` ベースに置き換える。
3. 絵文字・結合絵文字を含む入力で一次送信/確認送信の疎通確認を行う。
4. 問題発生時は変換適用を送信レイヤーのみで切り戻せるよう、差分を送信処理周辺に限定する。

## Open Questions

- なし
