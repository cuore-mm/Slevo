## Context

issue #449 の連続修正で、本体（viewer）と下部サムネイル（thumbnail）の失敗状態は URL キーで分離されました。これにより「サムネイル成功が本体失敗を勝手に解除する」問題は解消されましたが、サムネイル側で失敗時に画像コンポーネント描画を止める分岐があるため、成功イベントが再発火せず失敗状態が解除されない自己ロックが発生しています。

ユーザー体験としては本体再試行ボタンが「その画像の再取得」を意味するため、明示操作時だけ本体とサムネイルを同期再試行する振る舞いが自然です。通常時は誤連動を防ぐため独立性を維持します。

## Goals / Non-Goals

**Goals:**
- 通常時は本体失敗状態とサムネイル失敗状態の独立を維持する。
- 本体再試行時のみ同一 URL の本体/サムネイル失敗状態を同時解除し、両表示が回復可能になるようにする。
- サムネイル失敗状態の自己ロックを解消し、失敗オーバーレイ表示から回復可能な状態遷移を保証する。

**Non-Goals:**
- 404/410 表示文言や既存デザインを変更すること。
- 本体以外（例: スレッド画面サムネイル）の再試行契約を変更すること。
- 自動再試行ポリシーを全面的に復活させること。

## Decisions

1. 再試行連動は「明示操作時のみ」に限定する。
   - 代替案: 常時連動（成功/失敗を双方へ即時反映）。
   - 採用理由: 常時連動は過去不具合（サムネイル成功による本体自動復帰）を再発させるため。

2. 本体再試行イベントで同一 URL の `viewerFailure` と `thumbnailFailure` を同時解除する。
   - 代替案: 本体状態のみ解除し、サムネイルは自然回復待ち。
   - 採用理由: ユーザー意図（画像単位の再取得）と一致し、表示不整合（本体成功/サムネ失敗残存）を減らせるため。

3. サムネイル再取得には nonce ベースの明示トリガーを導入する。
   - 代替案: 失敗中でも常時 `SubcomposeAsyncImage` を描画して自然回復を許可。
   - 採用理由: 「明示再試行のみ再取得」の契約を守りつつ、失敗自己ロックを確実に解消できるため。

## Risks / Trade-offs

- [Risk] 本体再試行操作でサムネイル再取得が同時発生し、一時的に負荷が増える
  → Mitigation: 同一 URL の最小範囲に限定し、全件再取得を避ける。

- [Risk] nonce 管理漏れでサムネイルが再取得されない
  → Mitigation: ViewModel で URL 単位の retry nonce 状態を一元管理し、再試行経路を単一化する。

- [Trade-off] 再試行連動の仕様が明示操作依存となり、暗黙回復は減る
  → Mitigation: 仕様として明示し、UI は再試行導線を維持する。

## Migration Plan

1. ViewModel に「本体再試行時の両失敗状態解除 + サムネイル再試行トリガー更新」を追加する。
2. `ImageViewerThumbnailBar` のモデルキーへ URL + retry nonce を適用し、明示再試行時の再取得を保証する。
3. 既存 404/410 分岐と再試行導線が維持されることを回帰確認する。
4. 自己ロック再現ケース（サムネイル一時失敗後の復帰）で解除可能になることを確認する。

## Open Questions

- サムネイル再試行トリガーの状態保持を `Map<String, Int>` とするか、URL 正規化後キーへ集約するかは実装時に決定する。
