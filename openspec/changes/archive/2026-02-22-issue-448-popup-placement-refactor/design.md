## Context

現状の `ReplyPopup` は、段数別左余白・幅上限・X/Yオフセット補正を複数の関数で分担している。
これにより、同じ表示仕様を維持しながら調整する際に、どの関数を変更すべきか判断しづらい。
また、未計測時のフォールバックで `Int.MAX_VALUE` などの疑似値が使われ、通常経路と補助経路が混在している。

## Goals / Non-Goals

**Goals:**
- 配置責務（余白、幅上限、右見切れ防止、Y補正）を単一の計算経路に統合する。
- 既存の見た目仕様を変えず、実装のみを簡素化する。
- 未計測時挙動を明示化し、疑似値依存を削減する。

**Non-Goals:**
- 左余白ステップ値、右余白値、最大左余白値の仕様変更。
- ポップアップ高さ縮小ロジックの変更。
- ポップアップ追加トリガー（タップ投稿基準）の変更。

## Decisions

- **配置計算を単一エントリ関数へ集約する**
  - `calculatePopupPlacement`（名称は実装時決定）で X/Y 計算を統合し、呼び出し側はこの結果だけを使う。
  - 既存の小関数は責務が重複するものを統廃合する。

- **余白主導の計算順序を固定する**
  - 1) 段数から左余白算出、2) 幅上限算出、3) 右見切れ防止のX補正、4) Y補正 の順に統一する。
  - 計算順序を固定することで、表示差分の原因追跡を容易にする。

- **未計測時を明示ステートとして扱う**
  - `Int.MAX_VALUE` のような疑似画面幅での代替計算は避け、未計測時のフォールバックロジックを専用分岐にする。
  - これにより、通常経路の式を汚さずに境界条件を扱える。

- **テストを意図ベースに再構成する**
  - 「段数別左余白」「右端クランプ」「未計測時フォールバック」を独立観点で検証する。
  - 断片式テストより、仕様意図に対応したテスト名と入力を優先する。

## Risks / Trade-offs

- [Risk] 統合時に既存UIの位置がわずかに変化する可能性。
  - Mitigation: リファクタリング前後で代表ケース（1〜4段）を比較し、差分が仕様内か確認する。

- [Risk] 関数統合で一時的に行数が増える可能性。
  - Mitigation: セクションコメントで計算ステップを明示し、責務を1関数内で分離する。

- [Trade-off] 旧ヘルパー削除により、過去の検証知識がコード上で辿りにくくなる。
  - Mitigation: テストケース名に仕様意図を残し、設計判断を OpenSpec に記録する。
