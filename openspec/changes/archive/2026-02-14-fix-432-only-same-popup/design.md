## Context

issue #432 では、スレッド画面のレスポップアップを辿る操作中に、最上位ポップアップと同一内容のポップアップを連続で追加できる。現在は `ThreadViewModel.appendPopup` が入力された `PopupInfo` を無条件で `popupStack` に積むため、IDタップや返信番号タップなど全経路で同一連続追加が起きる。

本件の要求は「連続同一のみ抑止」であり、異なるポップアップを挟んだ再表示（A→B→A）は許可される。したがって、スタック全体の重複排除ではなく「最上位要素との比較」に限定した設計が必要である。

## Goals / Non-Goals

**Goals:**
- 同一内容ポップアップの連続追加を抑止する。
- 既存のポップアップ遷移（返信元・返信番号・ID・ツリー）を壊さない。
- A→B→A の再表示許可を維持する。
- 判定ルールをテスト可能な形で整理する。

**Non-Goals:**
- `popupId` の採番方式変更や永続的識別子化。
- ポップアップスタック全体の重複排除。
- ポップアップUIレイアウト、アニメーション、shared transitionの仕様変更。

## Decisions

- `appendPopup` に直前比較ガードを追加し、`state.popupStack.lastOrNull()` と新規追加候補が同一内容なら追加しない。
  - 理由: すべての追加経路が最終的に `appendPopup` を通るため、1箇所で要件を満たせる。
  - 代替案: 各 `addPopupFor*` で個別判定。却下理由は重複ロジック増加と経路ごとの差異発生リスク。
- 同一内容判定は `popupId` を除外し、表示内容を表すデータ（投稿集合とツリーインデント情報）で判定する。
  - 理由: `popupId` は採番値であり、同一内容でも毎回変わるため重複判定に使えない。
  - 代替案: `popupId` を内容ハッシュへ変更。却下理由は既存の安定識別用途への影響範囲が広く、今回の修正スコープを超える。
- テスト観点は ViewModel ユニットテストとして追加し、以下を最小セットで保証する。
  - 同一内容の連続追加は 1 件にとどまる。
  - 異なる内容を挟んだ同一再表示（A→B→A）は許可される。
  - 既存のポップアップ追加経路が抑止ルール適用後も成立する。

## Risks / Trade-offs

- [Risk] 同一内容判定が厳密すぎる/緩すぎると、意図しない抑止または未抑止が発生する。 → Mitigation: 要求どおり「最上位との連続比較のみ」に限定し、A→B→A を明示テストする。
- [Risk] 比較対象にレイアウト依存値を含めると端末状態で判定が揺れる。 → Mitigation: 判定からレイアウト都合の値を除外し、内容データ中心で比較する。
- [Trade-off] 1ステップ前のみ比較するため、スタック内の非連続重複は残る。 → Mitigation: これは要件どおりの挙動であり、過剰抑止を避けるために受容する。
