## Context

`ThreadScreen` の `LazyColumn` は現在 `"${display.num}_${display.dimmed}"` をキーにしている。TREE表示で更新を繰り返すと、更新グループの連結により同一レス番号が複数回表示されることがあり、同じ `num` と `dimmed` の組み合わせが同一リスト内で再出現する。
この状態で Compose のキー重複検出が発火し、`IllegalArgumentException` により画面がクラッシュする。

## Goals / Non-Goals

**Goals:**
- TREE表示かつ複数回更新時でも `LazyColumn` のアイテムキー重複を防止する。
- 表示順や新着バー位置の既存仕様（`thread-response-order`）を維持したままクラッシュだけを解消する。
- 仕様とテスト観点を追加し、同種の回 regressions を防止する。

**Non-Goals:**
- 更新グループの生成アルゴリズムそのものを再設計すること。
- TREE/NUMBER の表示順ルールや新着境界の挙動を変更すること。
- UIデザインや操作導線を変更すること。

## Decisions

1. 表示行キーを「行コンテキストを含む一意キー」へ変更する。
   - 採用案: 既存 `display` 情報に加えて、リスト上の行位置またはグループ文脈を含めたキーを使う。
   - 理由: 同一レス番号が再登場しても、同じレンダリング行として衝突しないことを保証できるため。
   - 代替案: `num` のみ、`num + dimmed` のみは再登場ケースで衝突するため不採用。

2. 変更範囲は「キー生成」と「検証テスト」に限定する。
   - 理由: 不具合の根因は識別子衝突であり、表示内容や順序ロジックを変更せずに修正可能なため。
   - 代替案: グループ連結ロジックを改修して重複表示自体を排除する案は、既存要件への影響が大きく不採用。

3. 仕様は `thread-response-order` の delta spec として管理する。
   - 理由: 本変更は新機能ではなく、既存「更新グループを保持して表示する」要件に対する安全性要件の追記であるため。

## Risks / Trade-offs

- [Risk] インデックス依存のキーにすると、並び替え時に再利用最適化が弱まる可能性 → 安定性を優先し、必要なら後続で専用 stable key の導入を検討する。
- [Risk] テストがキー生成実装の詳細に過度依存する可能性 → 「重複が起きない」という結果ベースの検証を主軸にする。
- [Trade-off] 変更を最小化するため、今回の対応では表示データモデルの全面的な再定義は行わない。

## Migration Plan

1. キー生成戦略を修正する。
2. TREE表示の複数更新ケースでキー重複が生じないことをユニットテストで検証する。
3. 既存の表示順・新着バーのテストを再実行し、回 regressions がないことを確認する。

ロールバック時はキー生成の変更のみを戻せばよく、データ移行は不要。

## Open Questions

- なし（不具合再現条件と修正方針は確定済み）。
