## Context

issue #449 では、画像読み込み失敗時にユーザーがその場で再試行できる導線が必要です。現状の UI は失敗状態を一部で内部的に扱うのみで、再読み込み操作を提供していません。

対象は 3 つの表示面（投稿内サムネイル、画像ビューア本体、画像ビューア下部サムネイル）であり、既存のページ切り替え契約やバー表示契約を壊さずに失敗時の操作を追加する必要があります。なお、ユーザー指定により ImageViewerTopBar への新規アクション追加は行いません。

## Goals / Non-Goals

**Goals:**
- 投稿内サムネイルで失敗状態を視認可能にし、タップで当該画像のみ再読み込みできるようにする。
- 画像ビューア本体で表示中画像の失敗時に再試行操作を提供する。
- 画像ビューア下部サムネイルで失敗状態を表示しつつ、サムネイルタップ時の既存ページ切り替え契約を維持する。
- 既存の shared transition、ページング、バー表示切り替えの契約を変更しない。

**Non-Goals:**
- ImageViewerTopBar のボタン追加やメニュー構成変更。
- 画像取得ライブラリ（Coil）設定の全面的な刷新。
- 画像保存・共有・NG メニューなど再読み込み以外の機能変更。

## Decisions

1. 再試行は「対象画像単位のリクエスト再生成」で実装する。
   - 代替案: ImageLoader 全体のメモリ/ディスクキャッシュを強制破棄して再取得する。
   - 採用理由: 全体破棄は副作用範囲が広く、他画像の表示性能に悪影響を与えるため。対象画像だけ再リクエストする方が局所的で安全。

2. 失敗状態は表示面ごとに保持し、UI はその状態に応じてオーバーレイ表示を切り替える。
   - 代替案: 単一のグローバル失敗状態で 3 画面を横断制御する。
   - 採用理由: 3 箇所の表示契約が異なり、操作（再試行/ページ切替）も異なるため、局所状態管理の方が実装と保守が明確。

3. 画像ビューアの再試行導線はトップバーではなく、ページコンテンツ上の失敗オーバーレイに配置する。
   - 代替案: トップバーにリロードボタンを追加する。
   - 採用理由: ユーザー指定（TopBar には追加しない）を満たしつつ、失敗対象と再試行操作を同一視線上に配置できるため。

4. 画像ビューア下部サムネイルの失敗時タップは既存どおりページ切り替えを優先し、再試行操作は本体側で提供する。
   - 代替案: 下部サムネイルタップを再試行に切り替える。
   - 採用理由: issue 受け入れ条件で「通常時と同じページ切り替え」が明示されているため。

## Risks / Trade-offs

- [Risk] 失敗判定とローディング判定が競合し、失敗オーバーレイが残留する可能性
  → Mitigation: onStart/onLoading で失敗状態を必ず解除し、onError でのみ失敗フラグを立てる状態遷移を統一する。

- [Risk] 再試行トリガーにより shared transition 対象キーと描画更新タイミングが衝突する可能性
  → Mitigation: shared transition キーは URL+index 契約を維持し、再試行はリクエスト再生成キーのみに閉じる。

- [Risk] 失敗表示の追加でタップ領域が曖昧になり誤操作が増える可能性
  → Mitigation: 投稿内サムネイルは失敗時オーバーレイ全体タップを再試行、下部サムネイルは既存タップ契約を維持して役割を明確化する。

## Migration Plan

1. `ImageThumbnailGrid` に失敗状態と再試行トリガーを追加し、失敗時オーバーレイとタップ再読み込み契約を実装する。
2. `ImageViewerPager` にページ単位の失敗状態を追加し、失敗時に再試行 UI を表示する。
3. `ImageViewerThumbnailBar` に失敗サムネイルのリロードアイコン表示を追加し、タップ時ページ切り替え契約の回帰を確認する。
4. 文字列リソース（再読み込みの contentDescription）を既存流用または追加で整理する。
5. 受け入れ条件 3 点に対する UI 動作確認（成功/失敗/再試行）を実施する。

## Open Questions

- なし（TopBar 非追加方針を前提に確定）。
