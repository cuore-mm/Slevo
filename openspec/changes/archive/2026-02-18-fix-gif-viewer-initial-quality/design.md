## Context

現在の画像ビューアは `ImageViewerPager` で `ImageRequest` を `remember(imageUrl, context)` に固定して生成し、表示成功時の `diskCacheKey` を共有アクション再利用レジストリへ登録している。スレッド画面の GIF サムネイルから遷移した初回ページのみ画質が粗く、ページ移動後に高画質へ回復するため、初回リクエストが低解像度条件で確定する経路が疑われる。

この変更では、初回表示品質の安定化と、既存の共有/保存高速化契約（再利用メタデータ登録）および読み込み進捗表示契約の両立が必要である。

## Goals / Non-Goals

**Goals:**
- GIF サムネイル起点で画像ビューアへ遷移した場合でも、初回表示から適切な解像度で描画する。
- 初回表示の品質改善後も、`diskCacheKey` 等の再利用メタデータ登録契約を維持する。
- 既存の shared transition、ページング、進捗表示、共有/保存アクションの振る舞いを後方互換で維持する。

**Non-Goals:**
- 画像ビューア UI デザインやメニュー構成の変更。
- 画像共有/保存機能そのものの仕様追加。
- Coil や Telephoto のライブラリアップグレード。

## Decisions

1. **ビューア画像リクエストは表示制約変化を反映できる構成にする。**
   - 理由: URL だけをキーにした固定化を避け、初回表示で低解像度条件が残留するリスクを下げる。
   - 代替案A: 既存の `remember(imageUrl, context)` を維持して GIF のみ個別分岐する。
     - 不採用理由: 分岐が増え、JPEG/PNG を含む同種の初回品質問題へ汎用的に効かない。
   - 代替案B: shared transition を無効化して回避する。
     - 不採用理由: 視覚遷移体験を犠牲にし、既存仕様への影響が大きい。

2. **再利用メタデータ登録は維持し、表示品質改善と独立に扱う。**
   - 理由: 共有/外部起動高速化の要件は有効であり、今回の不具合原因は登録目的そのものではなく初回リクエスト評価条件にある。
   - 代替案: レジストリ登録を削除する。
     - 不採用理由: 既存改善の機能退行を招く。

3. **検証は GIF 初回品質と既存契約回帰をセットで行う。**
   - 理由: 品質改善のみ確認すると、共有/保存や進捗表示で回帰が混入する可能性がある。

## Risks / Trade-offs

- [リスク] 表示制約追従により再リクエスト回数が増える可能性 → [緩和] キャッシュヒット前提で実測し、不要な再生成キーを最小化する。
- [リスク] shared transition 中の見え方が変わる可能性 → [緩和] 遷移中と遷移後の両方で画質とレイヤ順を確認する。
- [リスク] 再利用メタデータ登録タイミングがずれる可能性 → [緩和] 共有/保存アクションの手動回帰（単体/複数画像）を必須化する。

## Migration Plan

1. 画像ビューアのリクエスト生成ロジックを改善し、初回表示品質の安定化を実装する。
2. GIF サムネイル起点の初回表示を実機確認し、ページ移動なしで高品質表示されることを確認する。
3. 共有/保存/進捗表示/shared transition の回帰確認を実施する。
4. 問題発生時は、変更対象を `ImageViewerPager` 周辺へ限定してロールバック可能な粒度で差分管理する。

## Open Questions

- なし（現時点では原因仮説と対策方針が一致しており、実装前に追加の仕様判断は不要）。
