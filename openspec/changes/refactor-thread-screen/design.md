## Context

`ThreadScreen` は単一ファイル内で多数の `LaunchedEffect`、`NestedScrollConnection`、投稿リスト描画、ポップアップ連携、メニュー/ダイアログ表示を扱っている。
現状は責務境界が曖昧で、特定機能だけを修正する場合でも広範囲の読解が必要になる。特にスクロール関連の副作用と投稿行内コールバック重複は、回帰の温床になりやすい。

本変更は機能追加ではなく、既存挙動を維持したまま内部構造を整理するリファクタリングである。

## Goals / Non-Goals

**Goals:**
- `ThreadScreen` の責務を「画面オーケストレーション」「副作用処理」「リスト描画」「オーバーレイ表示」に分割する。
- 最終既読更新・自動スクロール・下端更新判定の副作用を独立単位へ切り出し、依存キーとトリガーを明確化する。
- 投稿行から呼ばれる重複処理（ポップアップ座標計算など）を補助関数化し、挙動を統一する。
- リファクタリング後も既存のユーザー挙動を不変に保つ。

**Non-Goals:**
- スレッド画面の新機能追加や既存機能削除。
- 画面デザイン、文言、レス表示仕様、ナビゲーション仕様の変更。
- `ThreadViewModel` のドメインロジック契約変更。

## Decisions

- **`ThreadScreen` をオーケストレーターに限定する**
  - 画面本体は state/handler の受け渡しとコンポーネント構成に集中し、ロジック実行主体を補助Composable/関数へ分離する。
  - 代替案として単一関数のままセクションコメントだけ増やす案は、責務分離が進まず変更影響範囲を縮小できないため採用しない。

- **副作用群を用途単位で分離する**
  - `LaunchedEffect` 群を「最終既読更新」「自動スクロール」「下端更新判定/ドラッグ監視」「ジェスチャーヒント表示制御」に分離し、依存関係を局所化する。
  - 代替案として副作用を 1 つの大きな effect に統合する案は、条件分岐の肥大化により可読性と検証性が下がるため採用しない。

- **リスト描画と行描画を分離する**
  - `LazyColumn` の構築、ミニマップバー分岐、投稿行 (`PostItem`) 周辺ロジックを責務別に分割する。
  - 代替案として `LazyListScope` だけ分離する案は、行内ロジック重複が残るため不十分。

- **重複する補助ロジックを関数化する**
  - ポップアップ基準座標の決定や末尾スクロールのターゲット算出など、同一アルゴリズムが複数箇所にある処理を共通化する。
  - 代替案として重複を許容する案は、片側修正時の不整合リスクが高いため採用しない。

## Risks / Trade-offs

- [Risk] 副作用切り出し時に `LaunchedEffect` の依存キーが変わり、発火タイミングがずれる可能性。
  - Mitigation: 既存キーと実行順を保った分割を原則とし、分割前後で同一シナリオを回帰確認する。

- [Risk] 関数分割でパラメータ受け渡しが増え、接続ミスが発生する可能性。
  - Mitigation: 入出力を責務単位でまとめた引数セットにし、呼び出し側で意味が追える命名を徹底する。

- [Trade-off] ファイル数/関数数が増えるため、初見では参照先が増える。
  - Mitigation: 役割ベースの命名を統一し、`ThreadScreen` から読み下せる構造を維持する。

## Migration Plan

1. 副作用分離を先行し、`ThreadScreen` の状態依存を壊さずに切り出す。
2. 投稿リスト描画を分離し、`PostItem` 連携の重複処理を補助関数へ集約する。
3. スクロールバー分岐とオーバーレイ表示を整理して、画面本体をオーケストレーター構成へ収束させる。
4. 手動確認と既存テストで挙動不変を確認する。

## Open Questions

- `ToBottom` ジェスチャー処理を `BoardScreen` と共通化する範囲を本変更に含めるか、後続変更で分離するか。
- `ThreadScreen` 分割時に同一パッケージ内でファイルを増やすか、`effects` / `components` サブパッケージを導入するか。
