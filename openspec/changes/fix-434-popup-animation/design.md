## Context

Issue #434 では、スレッド画面でレスポップアップを開いたまま画像ビューアへ遷移し、戻ったときに既存ポップアップへ再度 enter アニメーションが適用される。現在の実装は、ポップアップ内容自体は ViewModel の `popupStack` で保持される一方、アニメーション状態は Composable 内ローカル状態として再構築されるため、画面復帰時に「既存表示」と「新規表示」の境界が失われる。

## Goals / Non-Goals

**Goals:**
- 画面復帰時、既に表示済みのポップアップに対して enter アニメーションを再実行しない。
- ユーザー操作で新規追加されたポップアップには、従来どおり enter アニメーションを適用する。
- 既存の閉鎖アニメーション、階層表示、タップ操作、shared transition 挙動を維持する。

**Non-Goals:**
- ポップアップ表示位置やサイズ計算ロジックの全面的な再設計。
- ナビゲーション遷移仕様や画像ビューア側の UI/UX 変更。
- ポップアップ機能全体の状態管理方式（ViewModel 主体）そのものの変更。

## Decisions

1. Composable 初期同期時に「既存ポップアップ」を非アニメ表示として扱う。
   - 採用: `popupStack` が既に存在する状態で `ReplyPopup` が再構築された場合、可視状態リストを `currentState=true/targetState=true` で初期化する。
   - 理由: 不具合の原因が UI 層の初期化境界にあるため、責務に沿って最小変更で対処できる。
   - 代替案: ViewModel に「表示済み popupId」などアニメーション制御状態を持たせる。
   - 不採用理由: UI 実装都合の状態をドメイン寄り状態へ持ち込むことで責務が増え、変更波及が広がる。

2. 追加ポップアップは従来どおり enter アニメーションを維持する。
   - 採用: 初期同期後に増えた要素のみ `false -> true` の遷移で追加する。
   - 理由: バグ修正後も現行 UX（新規ポップアップの視覚フィードバック）を維持できる。
   - 代替案: 全ケースで enter アニメーションを無効化する。
   - 不採用理由: 新規表示時の視認性を下げ、既存 UX を劣化させる。

3. 変更範囲はレスポップアップ表示ロジックに限定する。
   - 採用: スレッド画面配下のポップアップ可視状態同期処理のみを修正対象とする。
   - 理由: リスクを局所化し、他画面や遷移ロジックへの副作用を最小化できる。
   - 代替案: Navigation/Lifecycle の復帰イベントを明示的に伝播してアニメーション可否を制御する。
   - 不採用理由: 画面間依存が増え、将来の画面追加時に保守負荷が上がる。

## Risks / Trade-offs

- [Risk] 初期表示判定が誤ると、本来アニメーションすべき新規ポップアップが無アニメになる → Mitigation: 「初回同期」と「追加同期」を明確に分離し、サイズ増減ケースを確認する。
- [Risk] 既存の閉鎖アニメーション完了契機が崩れる → Mitigation: 退場時の `targetState=false` と `onClose` 通知条件は変更しない。
- [Trade-off] UI ローカル状態に条件分岐が増える → Mitigation: 初期化関数を小さく保ち、意図を明示した命名で可読性を維持する。

## Migration Plan

1. 変更を適用してもデータ移行は不要（UI 挙動のみの変更）。
2. リリース時は通常配布で反映可能。
3. もし想定外の表示崩れが発生した場合は、可視状態初期化ロジックを従来実装へ戻すことでロールバックできる。

## Open Questions

- なし（Issue #434 の再現条件と期待挙動は明確）。
