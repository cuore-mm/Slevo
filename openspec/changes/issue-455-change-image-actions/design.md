## Context

Issue #455 は、画像の取得状態に関係なく同一の画像アクションを提示している現状を修正し、状態に応じて実行可能な操作だけを提示することを目的とする。

現行実装では、スレッド画面の `ImageMenuSheet` と画像ビューアの `ImageViewerTopBar` が固定メニューを描画し、実行は `ImageMenuActionRunner` へ委譲している。読み込み失敗種別は `ImageLoadFailureType`（`HTTP_404` / `HTTP_410` / `UNKNOWN`）で管理され、読み込み中状態はビューアでは `viewerImageLoadingUrls`、スレッドでは進捗レジストリ経由で判定可能な構成になっている。

要件上は、同一画像に対する状態を以下の4分類で扱う必要がある。
- 読み込み成功
- 読み込み失敗（404/410）
- 読み込み失敗（その他）
- 読み込み中

さらに読み込み中では新規アクション「読み込みを中止」を提供する。中止成立時は対象画像を再試行導線（リトライアイコン）へ遷移させるが、実行時点ですでに読み込み完了している場合は中止を無効化し、成功表示を維持する必要がある。画像ビューアではこの中止操作をトップバーのアイコンボタンとして提供する。

## Goals / Non-Goals

**Goals:**
- スレッド画面と画像ビューア画面で、画像読み込み状態に応じた表示アクション制御を統一する。
- 404/410 とその他失敗を分離し、要件どおりのメニュー構成へ切り替える。
- 読み込み中の中止アクションを追加し、中止成立時のみリトライ導線を表示する。
- メニュー表示中に画像状態が変化した場合、メニューを閉じずに内容をアニメーション付きで差し替える。
- 既存の共通アクション実行契約（共通ランナー、保存権限フロー、共有系挙動）を維持する。

**Non-Goals:**
- 画像読み込み基盤（Coil/Interceptor/Progress集約）の全面刷新。
- 既存アクションの意味変更（保存・共有・コピー・外部起動・検索の処理内容変更）。
- 404/410 の表示文言・エラーデザインそのものの再設計。

## Decisions

1. 状態判定と表示アクション対応表をUI共通契約として定義する
- 決定: 画像状態を `SUCCESS` / `FAIL_404_410` / `FAIL_OTHER` / `LOADING` に正規化し、画面ごとの描画層はこの状態から表示可能アクション集合を決定する。
- 理由: 画面ごとにif分岐を重複させると、Issue #455 のような条件追加時に差分が再発するため。
- 代替案: 既存の各画面コンポーネント内で個別分岐する。
  - 不採用理由: スレッド画面とビューア画面での不整合が再発しやすい。

2. 中止アクションは共通アクション種別に追加し、画面固有の表示位置で出し分ける
- 決定: `ImageMenuAction` に中止アクションを追加し、スレッド画面ではメニュー項目、ビューアではトップバーアイコンとして公開する。
- 理由: 実行処理契約は共通化しつつ、Issue要件の「ビューアではトップバーアイコン表示」を満たせるため。
- 代替案: ビューア専用アクションとしてViewModel直結で処理する。
  - 不採用理由: 同一ユースケースの処理経路が分裂し、保守性が下がる。

3. 中止アクションは「読み込み中の要求」に対してのみ成立させる
- 決定: 中止操作時に対象URLが `LOADING` である場合のみ中止を成立させ、`SUCCESS` へ遷移済みの場合は no-op として扱う。中止成立時のみ対象URLを「失敗（その他）」相当へ遷移させ、既存のリトライUIを再利用する。
- 理由: ユーザー操作と非同期完了の競合で成功状態を後から壊さないため。
- 代替案: 中止操作を常に優先し、完了済みでも失敗へ上書きする。
  - 不採用理由: 表示済み画像を不要に失敗表示へ戻してUXを損なう。

4. 404/410 では Google レンズを非表示にし、その他失敗・読み込み中でのみ表示する
- 決定: 失敗種別判定に基づき、404/410 では `NG追加` と `URLコピー` のみに制限し、その他失敗と読み込み中では `Googleレンズ` を許可する。
- 理由: Issue受け入れ条件を直接満たすため。
- 代替案: 失敗種別に関係なく失敗時は同一メニューにする。
  - 不採用理由: 仕様不一致。

5. メニュー表示中の状態変化は自動dismissせず、内容を差し替える
- 決定: シート/ドロップダウン表示中に画像状態が変化した場合、メニューは開いたまま維持し、表示アクション集合だけを状態に合わせて再評価して差し替える。差し替え時は軽量アニメーションを付与する。
- 理由: 状態変化でメニューが自動的に閉じると操作中断感が強く、誤操作を誘発しやすいため。
- 代替案: 状態変化時にメニューを自動で閉じ、再度開かせる。
  - 不採用理由: 操作手数が増え、読み込み完了直後の連続操作体験が悪化する。

## Risks / Trade-offs

- [Risk] 画面間で状態判定入力（失敗Map/読み込み中判定）の粒度が異なり、同一URLでも表示差が出る可能性がある。  
  → Mitigation: 状態正規化関数の入力契約を明示し、同一URL・同一失敗種別・同一読み込み中条件で同一アクション集合になるテスト観点を追加する。

- [Risk] 読み込み中の中止が実際のネットワークリクエスト中断と同期せず、完了競合で状態不整合が発生する可能性がある。  
  → Mitigation: 中止成立条件を「実行時点で LOADING」に限定し、完了済みは no-op で成功表示を維持する契約を明文化する。

- [Risk] メニュー表示中の状態差し替えで急な内容変化が視覚ノイズになる可能性がある。  
  → Mitigation: 差し替えに短いアニメーションを適用し、dismissせずに連続操作可能な状態を維持する。

- [Risk] 既存の成功時アクション群に回帰が混入する可能性がある。  
  → Mitigation: 成功時は「既存どおり」の要件を明文化し、回帰確認タスクを設ける。

## Migration Plan

1. OpenSpecの `thread-image-menu` と `image-viewer` にデルタ仕様を追加する。
2. 実装時は状態判定契約を導入した上で、スレッド画面とビューア画面の表示制御を同時更新する。
3. 中止アクションの成立条件（LOADINGのみ）とリトライ導線遷移を統合し、完了競合時no-opを確認する。
4. メニュー表示中の状態変化で内容差し替えアニメーションが適用されることを確認する。

ロールバック時は、状態連動分岐を外して従来の固定メニュー構成へ戻す。

## Open Questions

- なし（Issue #455 の受け入れ条件で状態別アクション集合は確定済み）。
