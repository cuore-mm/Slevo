## MODIFIED Requirements

### Requirement: 画像メニューアクション実行の共通化
システムはスレッド画面の画像メニューで選択されたアクション実行を、画像ビューアと共通の実行処理で行うMUST。保存アクションについては、URL正規化・権限判定・保留URL管理・保存実行・結果通知までを画像ビューアと同一フローで処理しなければならないMUST。さらにシステムは対象画像の読み込み状態に応じて表示アクションを制御し、表示されないアクションは選択できないようにしなければならないMUST。

#### Scenario: 読み込み成功時は既存アクションを表示する
- **WHEN** 対象画像が読み込み成功状態で、ユーザーがスレッド画面の画像メニューを開く
- **THEN** システムは既存の成功時アクション（保存・コピー・URLコピー・外部アプリ起動・Googleレンズ・共有・一括保存条件）を表示する

#### Scenario: 404/410失敗時は限定アクションのみ表示する
- **WHEN** 対象画像の読み込み失敗種別が 404 または 410 で、ユーザーがスレッド画面の画像メニューを開く
- **THEN** システムは `NG追加` と `URLコピー` のみを表示し、それ以外のアクションを表示しない

#### Scenario: その他失敗時はレンズを含む失敗向けアクションを表示する
- **WHEN** 対象画像の読み込み失敗種別が 404/410 以外で、ユーザーがスレッド画面の画像メニューを開く
- **THEN** システムは `NG追加`、`URLコピー`、`Googleレンズ` を表示し、それ以外のアクションを表示しない

#### Scenario: 読み込み中は中止アクションを含む読み込み向けアクションを表示する
- **WHEN** 対象画像が読み込み中状態で、ユーザーがスレッド画面の画像メニューを開く
- **THEN** システムは `読み込みを中止`、`NG追加`、`URLコピー`、`Googleレンズ` を表示し、それ以外のアクションを表示しない

#### Scenario: 読み込み中の中止でリトライ導線へ遷移する
- **WHEN** 対象画像が読み込み中状態で、ユーザーが `読み込みを中止` を選択する
- **THEN** システムは対象画像の実リクエストをキャンセルし、対象画像をリトライ可能な表示状態へ遷移させる

#### Scenario: 読み込み完了後の中止操作は無効化する
- **WHEN** 対象画像が読み込み成功状態へ遷移した後に、ユーザーの `読み込みを中止` 操作が到達する
- **THEN** システムは中止操作を no-op として扱い、リトライ表示へ遷移させずに成功表示を維持する

#### Scenario: シート表示中に状態が変化したら内容を差し替える
- **WHEN** 画像メニューのシート表示中に対象画像状態が変化する
- **THEN** システムはシートを閉じずに表示アクションを再評価し、アニメーション付きで内容を差し替える

#### Scenario: 表示対象外アクションは実行されない
- **WHEN** 対象画像状態に対して非表示のアクション実行条件が発生する
- **THEN** システムは当該アクションを実行せず、クラッシュせずに処理を終了する

#### Scenario: 中止後に旧リクエスト完了通知が到達しても状態を巻き戻さない
- **WHEN** `読み込みを中止` 実行後に、キャンセル前リクエスト由来の成功または失敗通知が到達する
- **THEN** システムは当該通知を無効として扱い、対象画像を中止/リトライ可能状態のまま維持する

#### Scenario: スレッド画面とビューア画面で読み込み状態を共有する
- **WHEN** スレッド画面で対象画像を `読み込みを中止` した後に画像ビューア画面へ遷移する
- **THEN** システムは同一URLの共有読み込み状態を参照し、ビューア画面でも中止/リトライ可能状態を表示する

#### Scenario: 権限許可後に同一対象で保存を再開する
- **WHEN** 保存権限が必要な端末で、表示中の保存アクションを実行後にユーザーが権限許可する
- **THEN** システムは権限要求前に保持した同一URL集合で保存処理を再開する
